<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduSphere | JEE/NEET Mock Test Platform</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Enhanced CSS Styles */
:root {
    --primary: #2563eb;
    --primary-light: #3b82f6;
    --primary-dark: #1d4ed8;
    --secondary: #8b5cf6;
    --accent: #f59e0b;
    --danger: #ef4444;
    --success: #10b981;
    --warning: #f59e0b;
    --dark: #1e293b;
    --light: #ffffff;
    --gray-50: #f8fafc;
    --gray-100: #f1f5f9;
    --gray-200: #e2e8f0;
    --gray-300: #cbd5e1;
    --gray-400: #94a3b8;
    --gray-500: #64748b;
    --gray-600: #475569;
    --gray-700: #334155;
    --gray-800: #1e293b;
    --gray-900: #0f172a;
    
    --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --gradient-primary: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
    --gradient-success: linear-gradient(135deg, #10b981 0%, #059669 100%);
    --gradient-warning: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    
    --glass: rgba(255, 255, 255, 0.95);
    --glass-dark: rgba(15, 23, 42, 0.95);
    --glass-border: rgba(255, 255, 255, 0.2);
    --shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    --shadow-lg: 0 25px 50px rgba(0, 0, 0, 0.15);
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    color: var(--gray-800);
    overflow-x: hidden;
    line-height: 1.6;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

/* Add these styles to fix UI issues */

/* Fix test interface positioning */
.test-interface {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--light);
    z-index: 1000;
    overflow-y: auto;
}

.test-header {
    background: var(--gradient-primary);
    color: white;
    padding: 1.5rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: var(--shadow);
    position: sticky;
    top: 0;
    z-index: 1001;
}

.test-timer {
    font-size: 1.5rem;
    font-weight: bold;
    background: rgba(255, 255, 255, 0.2);
    padding: 0.5rem 1rem;
    border-radius: 8px;
}

.question-container {
    padding: 2rem;
    max-width: 800px;
    margin: 0 auto;
}

.question-text {
    font-size: 1.25rem;
    margin-bottom: 2rem;
    line-height: 1.6;
    background: var(--gray-50);
    padding: 1.5rem;
    border-radius: 12px;
    border-left: 4px solid var(--primary);
}

.options-container {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin-bottom: 2rem;
}

.option {
    padding: 1.25rem;
    background: var(--light);
    border: 2px solid var(--gray-200);
    border-radius: 12px;
    cursor: pointer;
    transition: var(--transition);
    font-size: 1.1rem;
}

.option:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.option.selected {
    border-color: var(--primary);
    background: var(--primary-light);
    color: white;
    box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
}

.test-navigation {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem 2rem;
    background: var(--gray-50);
    border-top: 1px solid var(--gray-200);
    position: sticky;
    bottom: 0;
    z-index: 1001;
}

.question-palette {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    justify-content: center;
    flex: 1;
    margin: 0 2rem;
}

.palette-item {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--light);
    border: 2px solid var(--gray-300);
    border-radius: 8px;
    cursor: pointer;
    transition: var(--transition);
    font-weight: 600;
}

.palette-item:hover {
    border-color: var(--primary);
    transform: scale(1.1);
}

.palette-item.current {
    border-color: var(--primary);
    background: var(--primary);
    color: white;
    transform: scale(1.1);
}

.palette-item.answered {
    border-color: var(--success);
    background: var(--success);
    color: white;
}

/* Fix mock test creation form */
.mock-type-selector {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.mock-type-card {
    background: var(--light);
    border: 2px solid var(--gray-200);
    border-radius: 16px;
    padding: 2rem;
    text-align: center;
    cursor: pointer;
    transition: var(--transition);
}

.mock-type-card:hover {
    border-color: var(--primary);
    transform: translateY(-5px);
    box-shadow: var(--shadow);
}

.mock-type-card.selected {
    border-color: var(--primary);
    background: var(--primary-light);
    color: white;
    box-shadow: 0 8px 25px rgba(37, 99, 235, 0.3);
}

.mock-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
    color: var(--primary);
}

.mock-type-card.selected .mock-icon {
    color: white;
}

/* Fix form rows */
.form-row {
    display: flex;
    gap: 1rem;
}

.form-row .form-group {
    flex: 1;
}

/* Fix difficulty selector */
.difficulty-selector {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.difficulty-option {
    padding: 1rem 1.5rem;
    background: var(--gray-100);
    border: 2px solid var(--gray-300);
    border-radius: 12px;
    cursor: pointer;
    transition: var(--transition);
    text-align: center;
    flex: 1;
    min-width: 120px;
}

.difficulty-option:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
}

.difficulty-option.selected {
    border-color: var(--primary);
    background: var(--primary);
    color: white;
    box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
}

/* Fix question list in manual selection */
.question-list {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid var(--gray-200);
    border-radius: 12px;
    padding: 1rem;
}

.question-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: var(--gray-50);
    border-radius: 8px;
    margin-bottom: 0.5rem;
    border-left: 4px solid var(--primary);
}

.question-text {
    flex: 1;
    margin-right: 1rem;
}

.question-difficulty {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    margin-right: 1rem;
}

.difficulty-easy {
    background: var(--success);
    color: white;
}

.difficulty-medium {
    background: var(--warning);
    color: white;
}

.difficulty-hard {
    background: var(--danger);
    color: white;
}

/* Fix submit button position */
#submitTestBtn {
    margin: 2rem auto;
    display: block;
}

/* Fix hidden class */
.hidden {
    display: none !important;
}

/* Fix stats grid */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: var(--light);
    border: 1px solid var(--gray-200);
    border-radius: 16px;
    padding: 1.5rem;
    text-align: center;
    transition: var(--transition);
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow);
}

.stat-value {
    font-size: 2.5rem;
    font-weight: 800;
    background: var(--gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 0.5rem;
}

.stat-label {
    color: var(--gray-600);
    font-weight: 600;
}

/* Responsive fixes */
@media (max-width: 768px) {
    .test-navigation {
        flex-direction: column;
        gap: 1rem;
    }
    
    .question-palette {
        margin: 1rem 0;
        order: -1;
    }
    
    .form-row {
        flex-direction: column;
    }
    
    .difficulty-selector {
        flex-direction: column;
    }
    
    .test-header {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }
}

/* Enhanced Auth Styles */
.auth-container {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    position: relative;
}

.auth-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1000"><polygon fill="%23ffffff" fill-opacity="0.05" points="0,1000 1000,0 1000,1000"/></svg>');
}

.auth-card {
    background: var(--glass);
    backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: 24px;
    padding: 3rem;
    width: 100%;
    max-width: 440px;
    box-shadow: var(--shadow-lg);
    position: relative;
    z-index: 1;
    transform: translateY(0);
    transition: var(--transition);
}

.auth-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-lg), 0 10px 30px rgba(0, 0, 0, 0.2);
}

.logo {
    text-align: center;
    margin-bottom: 2.5rem;
}

.logo-icon {
    font-size: 3rem;
    background: var(--gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 1rem;
}

.logo-text {
    font-size: 2.5rem;
    font-weight: 800;
    background: var(--gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    letter-spacing: -0.5px;
}

/* Enhanced Form Styles */
.form-group {
    margin-bottom: 1.75rem;
}

.form-label {
    display: block;
    margin-bottom: 0.75rem;
    font-weight: 600;
    color: var(--gray-700);
    font-size: 0.95rem;
}

.form-input {
    width: 100%;
    padding: 1.125rem;
    background: var(--light);
    border: 2px solid var(--gray-200);
    border-radius: 12px;
    color: var(--gray-800);
    font-size: 1rem;
    transition: var(--transition);
    font-family: inherit;
}

.form-input:focus {
    outline: none;
    border-color: var(--primary);
    background: var(--light);
    box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
    transform: translateY(-2px);
}

/* Enhanced Button Styles */
.btn {
    padding: 1.125rem 2rem;
    border: none;
    border-radius: 12px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    font-family: inherit;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    position: relative;
    overflow: hidden;
}

.btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
}

.btn:hover::before {
    left: 100%;
}

.btn-primary {
    background: var(--gradient-primary);
    color: white;
    box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
}

.btn-primary:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(37, 99, 235, 0.4);
}

.btn-secondary {
    background: transparent;
    border: 2px solid var(--primary);
    color: var(--primary);
}

.btn-secondary:hover {
    background: var(--primary);
    color: white;
    transform: translateY(-2px);
}

/* Enhanced Dashboard */
.dashboard {
    display: none;
}

.header {
    background: var(--glass);
    backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    padding: 1.75rem;
    margin-bottom: 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: var(--shadow);
}

.user-info {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.user-avatar {
    width: 48px;
    height: 48px;
    background: var(--gradient);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: white;
    font-size: 1.25rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

/* Enhanced Navigation */
.nav-tabs {
    display: flex;
    gap: 1rem;
    margin-bottom: 2.5rem;
    flex-wrap: wrap;
    background: var(--glass);
    backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: 16px;
    padding: 0.75rem;
    box-shadow: var(--shadow);
}

.nav-tab {
    padding: 1rem 1.5rem;
    background: transparent;
    border: 2px solid transparent;
    border-radius: 12px;
    color: var(--gray-600);
    cursor: pointer;
    transition: var(--transition);
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex: 1;
    justify-content: center;
    min-width: 140px;
}

.nav-tab.active {
    background: var(--primary);
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(37, 99, 235, 0.3);
}

.nav-tab:hover:not(.active) {
    background: var(--gray-100);
    color: var(--gray-800);
    transform: translateY(-2px);
}

/* Enhanced Cards */
.card {
    background: var(--glass);
    backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: var(--shadow);
    transition: var(--transition);
}

.card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-lg);
}

.card-title {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 1.5rem;
    color: var(--gray-900);
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

/* Enhanced Test Grid */
.test-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 1.75rem;
}

.test-card {
    background: var(--light);
    border: 1px solid var(--gray-200);
    border-radius: 16px;
    padding: 2rem;
    transition: var(--transition);
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

.test-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--gradient);
}

.test-card:hover {
    transform: translateY(-8px);
    border-color: var(--primary);
    box-shadow: var(--shadow-lg);
}

.test-badge {
    background: var(--gradient);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 700;
    display: inline-block;
    margin-bottom: 1rem;
    letter-spacing: 0.5px;
}

/* Enhanced AI Guidance Section */
.guidance-result {
    margin-top: 2rem;
    background: var(--light);
    border-radius: 16px;
    border-left: 6px solid var(--primary);
    box-shadow: var(--shadow);
    overflow: hidden;
}

.guidance-header {
    background: var(--gradient-primary);
    color: white;
    padding: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.guidance-header h3 {
    margin: 0;
    font-size: 1.25rem;
}

.guidance-content {
    padding: 2rem;
}

.query-preview {
    background: var(--gray-50);
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1.5rem;
    border-left: 4px solid var(--primary);
}

.plan-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
    margin: 1.5rem 0;
}

.plan-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: var(--gray-50);
    border-radius: 12px;
    transition: var(--transition);
}

.plan-item:hover {
    transform: translateX(5px);
    background: var(--gray-100);
}

.plan-icon {
    font-size: 1.5rem;
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--gradient);
    border-radius: 50%;
}

.quick-tips {
    background: var(--gray-50);
    padding: 1.5rem;
    border-radius: 12px;
    margin: 1.5rem 0;
}

.quick-tips ul {
    list-style: none;
    padding: 0;
}

.quick-tips li {
    padding: 0.5rem 0;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.quick-tips li::before {
    content: '✓';
    color: var(--success);
    font-weight: bold;
}

.ai-note {
    background: var(--warning);
    color: var(--gray-900);
    padding: 1rem;
    border-radius: 8px;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-top: 1.5rem;
}

/* Enhanced Metrics */
.metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 1.25rem;
    margin-bottom: 2rem;
}

.metric-card {
    background: var(--light);
    border-radius: 16px;
    padding: 1.5rem;
    text-align: center;
    border: 1px solid var(--gray-200);
    transition: var(--transition);
    position: relative;
    overflow: hidden;
}

.metric-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--gradient);
}

.metric-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow);
}

.metric-value {
    font-size: 2rem;
    font-weight: 800;
    background: var(--gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 0.5rem;
}

/* Enhanced Performance Chart */
.performance-chart {
    height: 300px;
    background: var(--light);
    border-radius: 16px;
    padding: 1.5rem;
    display: flex;
    align-items: flex-end;
    justify-content: space-around;
    border: 1px solid var(--gray-200);
    position: relative;
}

.chart-bar {
    width: 50px;
    background: var(--gradient);
    border-radius: 8px 8px 0 0;
    transition: var(--transition);
    position: relative;
    cursor: pointer;
}

.chart-bar:hover {
    transform: scale(1.05);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
}

/* Loading Animation */
.loading {
    display: inline-block;
    width: 24px;
    height: 24px;
    border: 3px solid rgba(37, 99, 235, 0.3);
    border-radius: 50%;
    border-top-color: var(--primary);
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Floating Action Button */
.fab {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    width: 60px;
    height: 60px;
    background: var(--gradient);
    border: none;
    border-radius: 50%;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    box-shadow: var(--shadow-lg);
    transition: var(--transition);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.fab:hover {
    transform: scale(1.1) rotate(90deg);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

/* Enhanced Responsive Design */
@media (max-width: 768px) {
    .container {
        padding: 15px;
    }
    
    .auth-card {
        padding: 2rem;
        margin: 1rem;
    }
    
    .nav-tabs {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .nav-tab {
        min-width: auto;
        justify-content: flex-start;
    }
    
    .test-grid {
        grid-template-columns: 1fr;
    }
    
    .header {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }
    
    .metrics {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .plan-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 480px) {
    .auth-card {
        padding: 1.5rem;
    }
    
    .logo-text {
        font-size: 2rem;
    }
    
    .card {
        padding: 1.5rem;
    }
    
    .metrics {
        grid-template-columns: 1fr;
    }
}

/* Dark mode support */
@media (prefers-color-scheme: dark) {
    :root {
        --light: #0f172a;
        --gray-50: #1e293b;
        --gray-100: #334155;
        --gray-200: #475569;
        --gray-800: #f1f5f9;
    }
    
    body {
        background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    }
    
    .auth-card {
        background: var(--glass-dark);
        color: white;
    }
    
    .form-input {
        background: var(--gray-100);
        border-color: var(--gray-200);
        color: white;
    }
    
    .form-input:focus {
        background: var(--gray-100);
    }
}
    </style>
</head>
<body>
    <!-- Auth Section -->
    <div class="auth-container" id="authContainer">
        <div class="auth-card">
            <!-- Login Form -->
            <div id="loginSection">
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                    <div class="logo-text">EduSphere</div>
                    <p style="opacity: 0.8; margin-top: 0.5rem;">JEE/NEET Mock Test Platform</p>
                </div>
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label">Username</label>
                        <input type="text" class="form-input" id="username" placeholder="Enter your username" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" id="password" placeholder="Enter your password" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Role</label>
                        <select class="form-input" id="role">
                            <option value="student">Student</option>
                            <option value="teacher">Teacher</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary" id="loginBtn" style="width: 100%;">
                        <span>Sign In</span>
                    </button>
                </form>
                <div style="margin-top: 1rem; padding: 1rem; background: var(--gray-100); border-radius: 8px; font-size: 0.8rem;">
    <strong>Test Credentials:</strong><br>
    Admin: admin / admin123<br>
    Teacher: teacher / teacher123<br>
    Student: student / student123
</div>
                <div style="text-align: center; margin-top: 1.5rem; color: var(--gray-600);">
                    Don't have an account? <a href="#" style="color: var(--primary); text-decoration: none; font-weight: 600;" onclick="showRegister()">Sign up</a>
                </div>
            </div>

            <!-- Register Form -->
            <div id="registerSection" class="hidden">
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-user-plus"></i>
                    </div>
                    <div class="logo-text">Create Account</div>
                </div>
                <form id="registerForm">
                    <div class="form-group">
                        <label class="form-label">Username</label>
                        <input type="text" class="form-input" id="regUsername" placeholder="Choose a username" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" id="regPassword" placeholder="Create a password" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Role</label>
                        <select class="form-input" id="regRole">
                            <option value="student">Student</option>
                            <option value="teacher">Teacher</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary" id="registerBtn" style="width: 100%;">
                        <span>Create Account</span>
                    </button>
                </form>
                <div style="text-align: center; margin-top: 1.5rem; color: var(--gray-600);">
                    Already have an account? <a href="#" style="color: var(--primary); text-decoration: none; font-weight: 600;" onclick="showLogin()">Sign in</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="container">
        <div class="dashboard" id="dashboard">
            <!-- Header -->
            <div class="header">
                <div class="logo" style="text-align: left; margin: 0;">
                    <div class="logo-text">EduSphere</div>
                </div>
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div>
                        <div id="userName">User</div>
                        <div id="userRole" style="opacity: 0.7; font-size: 0.9rem;">Role</div>
                    </div>
                    <button class="btn btn-secondary" onclick="logout()" style="width: auto; padding: 0.5rem 1rem;">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>

            <!-- Navigation -->
            <div class="nav-tabs">
                <div class="nav-tab active" onclick="showSection('mockTests')">
                    <i class="fas fa-file-alt"></i> Mock Tests
                </div>
                <div class="nav-tab" onclick="showSection('createTest')">
                    <i class="fas fa-plus-circle"></i> Create Test
                </div>
                <div class="nav-tab" onclick="showSection('performance')">
                    <i class="fas fa-chart-line"></i> Performance
                </div>
                <div class="nav-tab" onclick="showSection('guidance')">
                    <i class="fas fa-robot"></i> AI Guidance
                </div>
                <div class="nav-tab hidden" id="adminTab" onclick="showSection('admin')">
                    <i class="fas fa-cogs"></i> Admin
                </div>
            </div>

            <!-- Content Sections -->
            <div class="content-section active" id="mockTestsSection">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2 class="card-title">Available Mock Tests</h2>
                        <button class="btn btn-secondary" onclick="refreshTests()" style="width: auto;">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    <div class="test-grid" id="testsGrid">
                        <!-- Test cards will be populated here -->
                    </div>
                </div>
            </div>

            <div class="content-section" id="createTestSection">
                <div class="card">
                    <h2 class="card-title">Create Custom Test</h2>
                    <div class="mock-type-selector">
                        <div class="mock-type-card" id="jeeCard" onclick="selectMockType('jee')">
                            <div class="mock-icon">
                                <i class="fas fa-calculator"></i>
                            </div>
                            <h3>JEE Mock Test</h3>
                            <p>Physics, Chemistry, Mathematics</p>
                        </div>
                        <div class="mock-type-card" id="neetCard" onclick="selectMockType('neet')">
                            <div class="mock-icon">
                                <i class="fas fa-stethoscope"></i>
                            </div>
                            <h3>NEET Mock Test</h3>
                            <p>Physics, Chemistry, Biology</p>
                        </div>
                    </div>
                    <div class="test-creation-form">
                        <div class="form-group">
                            <label class="form-label">Class</label>
                            <select class="form-input" id="testClass">
                                <option value="11">Class 11</option>
                                <option value="12">Class 12</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Subject</label>
                            <select class="form-input" id="testSubject">
                                <!-- Subjects will be populated based on mock type -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Chapter</label>
                            <select class="form-input" id="testChapter">
                                <!-- Chapters will be populated based on subject -->
                            </select>
                        </div>
                        <div class="form-group form-row">
                            <label class="form-label">Test Type</label>
                            <div class="difficulty-selector">
                                <div class="difficulty-option selected" data-level="auto" onclick="selectTestType('auto')">
                                    Auto Generate (Difficulty)
                                </div>
                                <div class="difficulty-option" data-level="manual" onclick="selectTestType('manual')">
                                    Manual Selection
                                </div>
                            </div>
                        </div>
                        <div class="form-group" id="difficultySection">
                            <label class="form-label">Difficulty Level</label>
                            <div class="difficulty-selector">
                                <div class="difficulty-option selected" data-level="mixed" onclick="selectDifficulty('mixed')">
                                    Mixed
                                </div>
                                <div class="difficulty-option" data-level="easy" onclick="selectDifficulty('easy')">
                                    Easy
                                </div>
                                <div class="difficulty-option" data-level="medium" onclick="selectDifficulty('medium')">
                                    Medium
                                </div>
                                <div class="difficulty-option" data-level="hard" onclick="selectDifficulty('hard')">
                                    Hard
                                </div>
                            </div>
                        </div>
                        <div class="form-group hidden" id="manualSection">
                            <label class="form-label">Select Questions</label>
                            <div class="question-list" id="availableQuestions">
                                <!-- Available questions will be listed here -->
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Number of Questions</label>
                            <input type="number" class="form-input" id="questionCount" min="1" max="50" value="10">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Duration (minutes)</label>
                            <input type="number" class="form-input" id="testDuration" min="5" max="180" value="30">
                        </div>
                        <div class="form-group form-row">
                            <button class="btn btn-primary" onclick="generateCustomTest()" style="width: 100%;">
                                <i class="fas fa-magic"></i> Generate Test
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="content-section" id="performanceSection">
                <div class="card">
                    <h2 class="card-title">Your Performance</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="totalTests">0</div>
                            <div class="stat-label">Tests Taken</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="avgScore">0%</div>
                            <div class="stat-label">Average Score</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="bestScore">0%</div>
                            <div class="stat-label">Best Score</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalTime">0h</div>
                            <div class="stat-label">Time Spent</div>
                        </div>
                    </div>
                    <div class="performance-chart" id="performanceChart">
                        <!-- Performance chart will be rendered here -->
                    </div>
                </div>
            </div>

            <div class="content-section" id="guidanceSection">
                <div class="card">
                    <h2 class="card-title">AI Learning Guidance</h2>
                    <div class="form-group">
                        <label class="form-label">Ask a question or request guidance</label>
                        <textarea class="form-input" id="aiQuery" rows="4" placeholder="Enter your question or topic (e.g., Explain organic chemistry reaction mechanisms, How to solve calculus problems, etc.)"></textarea>
                        <button class="btn btn-primary" onclick="getAIGuidance()" style="margin-top: 1rem; width: 100%;">
                            <i class="fas fa-magic"></i> Get AI Guidance
                        </button>
                    </div>
                    <div id="guidanceResult"></div>
                </div>
            </div>

            <div class="content-section" id="adminSection">
                <div class="card">
                    <h2 class="card-title">Admin Dashboard</h2>
                    <div id="adminContent">
                        <div class="form-group">
                            <button class="btn btn-primary" onclick="showQuestionManagement()">
                                <i class="fas fa-database"></i> Manage Question Bank
                            </button>
                            <button class="btn btn-secondary" onclick="showTestManagement()" style="margin-left: 1rem;">
                                <i class="fas fa-file-alt"></i> Manage Tests
                            </button>
                        </div>
                        <div id="questionManagement" class="hidden">
                            <h3 style="margin-bottom: 1rem;">Question Bank Management</h3>
                            <div class="test-creation-form">
                                <div class="form-group">
                                    <label class="form-label">Exam Type</label>
                                    <select class="form-input" id="examType" onchange="updateSubjectsForAdmin()">
                                        <option value="jee">JEE</option>
                                        <option value="neet">NEET</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Class</label>
                                    <select class="form-input" id="questionClass">
                                        <option value="11">Class 11</option>
                                        <option value="12">Class 12</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Subject</label>
                                    <select class="form-input" id="questionSubject" onchange="updateChaptersForAdmin()">
                                        <!-- Subjects will be populated based on exam type -->
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Chapter</label>
                                    <select class="form-input" id="questionChapter">
                                        <!-- Chapters will be populated based on subject -->
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Difficulty</label>
                                    <select class="form-input" id="questionDifficulty">
                                        <option value="easy">Easy</option>
                                        <option value="medium">Medium</option>
                                        <option value="hard">Hard</option>
                                    </select>
                                </div>
                                <div class="form-group form-row">
                                    <label class="form-label">Question Text</label>
                                    <textarea class="form-input" id="questionText" rows="3" placeholder="Enter the question text"></textarea>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Option A</label>
                                    <input type="text" class="form-input" id="optionA" placeholder="Option A">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Option B</label>
                                    <input type="text" class="form-input" id="optionB" placeholder="Option B">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Option C</label>
                                    <input type="text" class="form-input" id="optionC" placeholder="Option C">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Option D</label>
                                    <input type="text" class="form-input" id="optionD" placeholder="Option D">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Correct Answer</label>
                                    <select class="form-input" id="correctAnswer">
                                        <option value="A">A</option>
                                        <option value="B">B</option>
                                        <option value="C">C</option>
                                        <option value="D">D</option>
                                    </select>
                                </div>
                                <div class="form-group form-row">
                                    <label class="form-label">Solution/Explanation</label>
                                    <textarea class="form-input" id="questionSolution" rows="3" placeholder="Enter detailed solution and explanation"></textarea>
                                </div>
                                <div class="form-group form-row">
                                    <button class="btn btn-primary" onclick="addQuestion()" style="width: 100%;">
                                        <i class="fas fa-plus"></i> Add Question
                                    </button>
                                </div>
                            </div>
                            <div class="question-list" id="questionList">
                                <!-- Questions will be listed here -->
                            </div>
                        </div>
                        <div id="testManagement" class="hidden">
                            <h3 style="margin-bottom: 1rem;">Test Management</h3>
                            <div id="adminTestsList">
                                <!-- Admin tests will be listed here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Interface -->
    <div class="test-interface hidden" id="testInterface">
        <div class="container">
            <div class="test-header">
                <h2 id="testTitle">Mock Test</h2>
                <div class="test-timer" id="testTimer">30:00</div>
            </div>
            
            <div class="question-container">
                <div class="question-text" id="currentQuestionText">Question text will appear here</div>
                <div class="options-container" id="optionsContainer">
                    <!-- Options will be populated here -->
                </div>
            </div>
            <button class="fab" onclick="scrollToTop()" title="Scroll to Top">
    <i class="fas fa-arrow-up"></i>
</button>
            <div class="test-navigation">
                <button class="btn btn-secondary" id="prevBtn" onclick="prevQuestion()">
                    <i class="fas fa-arrow-left"></i> Previous
                </button>
                <div class="question-palette" id="questionPalette">
                    <!-- Question numbers will be populated here -->
                </div>
                <button class="btn btn-primary" id="nextBtn" onclick="nextQuestion()">
                    Next <i class="fas fa-arrow-right"></i>
                </button>
            </div>
            
            <div style="text-align: center; margin-top: 2rem;">
                <button class="btn btn-primary" id="submitTestBtn" onclick="submitTest()" style="width: 200px;">
                    <i class="fas fa-paper-plane"></i> Submit Test
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let currentRole = null;
        let currentSection = 'mockTests';
        let mockType = 'jee';
        let testType = 'auto';
        let difficulty = 'mixed';
        let currentTest = null;
        let currentQuestionIndex = 0;
        let testTimer = null;
        let timeRemaining = 0;
        let userAnswers = {};
        let questionBank = {};

        // Initialize the application
        // In the init() function, replace the token handling:
function init() {
    // Check if user is already logged in
    const savedUser = localStorage.getItem('currentUser');
    const savedRole = localStorage.getItem('currentRole');
    
    if (savedUser && savedRole) {
        currentUser = savedUser;
        currentRole = savedRole;
        showDashboard();
    } else {
        // Show login if no user found
        document.getElementById('authContainer').style.display = 'flex';
        document.getElementById('dashboard').style.display = 'none';
    }
    
    // Set up event listeners
    document.getElementById('loginForm').addEventListener('submit', handleLogin);
    document.getElementById('registerForm').addEventListener('submit', handleRegister);
    
    // Initialize mock type selection
    selectMockType('jee');
    updateSubjects();
    
    // Load initial data only if logged in
    if (currentUser && currentRole) {
        loadAvailableTests();
        updatePerformanceMetrics();
        loadQuestionBank();
    }
}
        // Load question bank from server
        async function loadQuestionBank() {
            try {
                const response = await fetch('/api/questions/bank');
                const data = await response.json();
                if (data.success) {
                    questionBank = data.questionBank;
                    console.log('Question bank loaded successfully');
                }
            } catch (error) {
                console.error('Error loading question bank:', error);
                // Load default question bank
                loadDefaultQuestionBank();
            }
        }
        function scrollToTop() {
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

        // Load default question bank (fallback)
        function loadDefaultQuestionBank() {
            questionBank = {
                jee: {
                    physics: {
                        '11': {
                            'Physical World and Measurement': [
                                { 
                                    id: 1, 
                                    text: 'Which of the following is not a fundamental unit?', 
                                    options: ['meter', 'second', 'kilogram', 'newton'], 
                                    answer: 'D', 
                                    difficulty: 'easy',
                                    solution: 'Newton is a derived unit, not a fundamental unit. The fundamental units in SI system are meter, second, kilogram, ampere, kelvin, mole, and candela.'
                                }
                            ],
                            'Kinematics': [
                                { 
                                    id: 2, 
                                    text: 'A particle moves along a straight line with velocity v = 3t² - 6t m/s. The acceleration at t=2s is:', 
                                    options: ['0 m/s²', '6 m/s²', '12 m/s²', '18 m/s²'], 
                                    answer: 'B', 
                                    difficulty: 'medium',
                                    solution: 'Acceleration a = dv/dt = 6t - 6. At t=2s, a = 6(2) - 6 = 12 - 6 = 6 m/s²'
                                }
                            ]
                        },
                        '12': {
                            'Electrostatics': [
                                { 
                                    id: 3, 
                                    text: 'Two point charges +4q and -q are placed at a distance r apart. The distance from +4q where the electric field is zero is:', 
                                    options: ['r/3 from +4q', 'r/3 from -q', '2r/3 from +4q', 'r/2 from +4q'], 
                                    answer: 'C', 
                                    difficulty: 'hard',
                                    solution: 'Let the point be at distance x from +4q. Then E due to +4q = k(4q)/x², E due to -q = k(q)/(r-x)². Setting them equal: 4/x² = 1/(r-x)² => 2/x = 1/(r-x) => 2r - 2x = x => 3x = 2r => x = 2r/3 from +4q.'
                                }
                            ]
                        }
                    },
                    chemistry: {
                        '11': {
                            'Some Basic Concepts of Chemistry': [
                                { 
                                    id: 4, 
                                    text: 'The number of moles of oxygen in 1L of air containing 21% oxygen by volume under standard conditions is:', 
                                    options: ['0.0093 mol', '0.186 mol', '0.21 mol', '2.1 mol'], 
                                    answer: 'A', 
                                    difficulty: 'medium',
                                    solution: 'Volume of O₂ in 1L air = 210 mL = 0.21 L. At STP, 1 mole occupies 22.4 L. So moles of O₂ = 0.21/22.4 = 0.009375 mol ≈ 0.0093 mol'
                                }
                            ]
                        },
                        '12': {
                            'Solutions': [
                                { 
                                    id: 5, 
                                    text: 'The boiling point of 0.1 molal aqueous solution of a non-volatile solute is 100.052°C. The value of Kb for water is:', 
                                    options: ['0.26 K kg mol⁻¹', '0.52 K kg mol⁻¹', '1.86 K kg mol⁻¹', '5.2 K kg mol⁻¹'], 
                                    answer: 'B', 
                                    difficulty: 'easy',
                                    solution: 'ΔTb = Kb × m => 0.052 = Kb × 0.1 => Kb = 0.052/0.1 = 0.52 K kg mol⁻¹'
                                }
                            ]
                        }
                    },
                    mathematics: {
                        '11': {
                            'Sets, Relations and Functions': [
                                { 
                                    id: 6, 
                                    text: 'If A = {1, 2, 3} and B = {2, 3, 4}, then A ∩ B is:', 
                                    options: ['{1, 2}', '{2, 3}', '{3, 4}', '{1, 4}'], 
                                    answer: 'B', 
                                    difficulty: 'easy',
                                    solution: 'A ∩ B is the set of elements common to both A and B. Common elements are 2 and 3, so A ∩ B = {2, 3}'
                                }
                            ]
                        },
                        '12': {
                            'Matrices and Determinants': [
                                { 
                                    id: 7, 
                                    text: 'If A is a square matrix of order 3 and |A| = 5, then |adj A| is:', 
                                    options: ['5', '25', '125', '625'], 
                                    answer: 'B', 
                                    difficulty: 'medium',
                                    solution: 'For a square matrix of order n, |adj A| = |A|ⁿ⁻¹. Here n=3, so |adj A| = 5² = 25'
                                }
                            ]
                        }
                    }
                },
                neet: {
                    physics: {
                        '11': {
                            'Physical World and Measurement': [
                                { 
                                    id: 8, 
                                    text: 'Which of the following is not a fundamental unit?', 
                                    options: ['meter', 'second', 'kilogram', 'newton'], 
                                    answer: 'D', 
                                    difficulty: 'easy',
                                    solution: 'Newton is a derived unit, not a fundamental unit. The fundamental units in SI system are meter, second, kilogram, ampere, kelvin, mole, and candela.'
                                }
                            ]
                        },
                        '12': {
                            'Electrostatics': [
                                { 
                                    id: 9, 
                                    text: 'Two point charges +4q and -q are placed at a distance r apart. The distance from +4q where the electric field is zero is:', 
                                    options: ['r/3 from +4q', 'r/3 from -q', '2r/3 from +4q', 'r/2 from +4q'], 
                                    answer: 'C', 
                                    difficulty: 'hard',
                                    solution: 'Let the point be at distance x from +4q. Then E due to +4q = k(4q)/x², E due to -q = k(q)/(r-x)². Setting them equal: 4/x² = 1/(r-x)² => 2/x = 1/(r-x) => 2r - 2x = x => 3x = 2r => x = 2r/3 from +4q.'
                                }
                            ]
                        }
                    },
                    chemistry: {
                        '11': {
                            'Some Basic Concepts of Chemistry': [
                                { 
                                    id: 10, 
                                    text: 'The number of moles of oxygen in 1L of air containing 21% oxygen by volume under standard conditions is:', 
                                    options: ['0.0093 mol', '0.186 mol', '0.21 mol', '2.1 mol'], 
                                    answer: 'A', 
                                    difficulty: 'medium',
                                    solution: 'Volume of O₂ in 1L air = 210 mL = 0.21 L. At STP, 1 mole occupies 22.4 L. So moles of O₂ = 0.21/22.4 = 0.009375 mol ≈ 0.0093 mol'
                                }
                            ]
                        },
                        '12': {
                            'Solutions': [
                                { 
                                    id: 11, 
                                    text: 'The boiling point of 0.1 molal aqueous solution of a non-volatile solute is 100.052°C. The value of Kb for water is:', 
                                    options: ['0.26 K kg mol⁻¹', '0.52 K kg mol⁻¹', '1.86 K kg mol⁻¹', '5.2 K kg mol⁻¹'], 
                                    answer: 'B', 
                                    difficulty: 'easy',
                                    solution: 'ΔTb = Kb × m => 0.052 = Kb × 0.1 => Kb = 0.052/0.1 = 0.52 K kg mol⁻¹'
                                }
                            ]
                        }
                    },
                    biology: {
                        '11': {
                            'Diversity in Living World': [
                                { 
                                    id: 12, 
                                    text: 'Which of the following is not a characteristic of living organisms?', 
                                    options: ['Growth', 'Reproduction', 'Metabolism', 'Isolated metabolic reactions'], 
                                    answer: 'D', 
                                    difficulty: 'easy',
                                    solution: 'Isolated metabolic reactions in vitro are not living things but living reactions. Growth, reproduction, and metabolism are defining characteristics of living organisms.'
                                }
                            ]
                        },
                        '12': {
                            'Reproduction': [
                                { 
                                    id: 13, 
                                    text: 'In humans, at the end of the first meiotic division, the male germ cells differentiate into the:', 
                                    options: ['Spermatids', 'Spermatogonia', 'Primary spermatocytes', 'Secondary spermatocytes'], 
                                    answer: 'D', 
                                    difficulty: 'medium',
                                    solution: 'The first meiotic division in male germ cells produces secondary spermatocytes from primary spermatocytes. Spermatids are formed after the second meiotic division.'
                                }
                            ]
                        }
                    }
                }
            };
        }

        // Handle login
       async function handleLogin(e) {
    e.preventDefault();
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    const role = document.getElementById('role').value;
    
    const loginBtn = document.getElementById('loginBtn');
    const originalText = loginBtn.innerHTML;
    loginBtn.innerHTML = '<div class="loading"></div> Signing in...';
    loginBtn.disabled = true;
    
    try {
        const response = await fetch('/api/auth/login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ username, password, role })
        });
        
        const data = await response.json();
        
        if (data.success) {
            currentUser = data.user.username;
            currentRole = data.user.role;
            
            // Save to localStorage
            localStorage.setItem('currentUser', currentUser);
            localStorage.setItem('currentRole', currentRole);
            localStorage.setItem('authToken', data.token);
            
            showDashboard();
        } else {
            alert(data.error || 'Login failed. Please check your credentials.');
        }
    } catch (error) {
        console.error('Login error:', error);
        alert('Login failed. Server might be down. Please try again.');
    } finally {
        loginBtn.innerHTML = originalText;
        loginBtn.disabled = false;
    }
}

        // Handle registration
        async function handleRegister(e) {
            e.preventDefault();
            const username = document.getElementById('regUsername').value;
            const password = document.getElementById('regPassword').value;
            const role = document.getElementById('regRole').value;
            
            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password, role })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Registration successful! Please login with your credentials.');
                    showLogin();
                } else {
                    alert(data.error || 'Registration failed');
                }
            } catch (error) {
                console.error('Registration error:', error);
                alert('Registration failed. Please try again.');
            }
        }

        // Show login form
        function showLogin() {
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('registerSection').classList.add('hidden');
        }

        // Show register form
        function showRegister() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('registerSection').classList.remove('hidden');
        }

        // Show dashboard
        function showDashboard() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            
            // Update user info
            document.getElementById('userName').textContent = currentUser;
            document.getElementById('userRole').textContent = currentRole.charAt(0).toUpperCase() + currentRole.slice(1);
            document.getElementById('userAvatar').textContent = currentUser.charAt(0).toUpperCase();
            
            // Show/hide admin tab based on role
            if (currentRole === 'admin') {
                document.getElementById('adminTab').classList.remove('hidden');
            } else {
                document.getElementById('adminTab').classList.add('hidden');
            }
            
            // Load initial data
            loadAvailableTests();
            updatePerformanceMetrics();
        }

        // Logout
        function logout() {
            currentUser = null;
            currentRole = null;
            localStorage.removeItem('currentUser');
            localStorage.removeItem('currentRole');
            localStorage.removeItem('authToken');
            location.reload();
        }

        // Show section
        function showSection(section) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(el => {
                el.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.nav-tab').forEach(el => {
                el.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(section + 'Section').classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            
            currentSection = section;
            
            // Load section-specific data
            if (section === 'mockTests') {
                loadAvailableTests();
            } else if (section === 'performance') {
                updatePerformanceMetrics();
            } else if (section === 'admin') {
                updateSubjectsForAdmin();
                loadQuestionsForAdmin();
                loadTestsForAdmin();
            }
        }

        // Select mock type (JEE/NEET)
        function selectMockType(type) {
            mockType = type;
            
            // Update UI
            document.getElementById('jeeCard').classList.remove('selected');
            document.getElementById('neetCard').classList.remove('selected');
            document.getElementById(type + 'Card').classList.add('selected');
            
            // Update subjects
            updateSubjects();
        }

        // Update subjects based on mock type
        function updateSubjects() {
            const subjectSelect = document.getElementById('testSubject');
            subjectSelect.innerHTML = '';
            
            let subjects = [];
            if (mockType === 'jee') {
                subjects = ['physics', 'chemistry', 'mathematics'];
            } else if (mockType === 'neet') {
                subjects = ['physics', 'chemistry', 'biology'];
            }
            
            subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject;
                option.textContent = subject.charAt(0).toUpperCase() + subject.slice(1);
                subjectSelect.appendChild(option);
            });
            
            // Update chapters
            updateChapters();
        }

        // Update chapters based on subject and class
        function updateChapters() {
            const classSelect = document.getElementById('testClass');
            const subjectSelect = document.getElementById('testSubject');
            const chapterSelect = document.getElementById('testChapter');
            
            const selectedClass = classSelect.value;
            const selectedSubject = subjectSelect.value;
            
            chapterSelect.innerHTML = '';
            
            if (questionBank[mockType] && questionBank[mockType][selectedSubject] && questionBank[mockType][selectedSubject][selectedClass]) {
                const chapters = Object.keys(questionBank[mockType][selectedSubject][selectedClass]);
                
                chapters.forEach(chapter => {
                    const option = document.createElement('option');
                    option.value = chapter;
                    option.textContent = chapter;
                    chapterSelect.appendChild(option);
                });
            }
            
            // Update available questions for manual selection
            if (testType === 'manual') {
                updateAvailableQuestions();
            }
        }

        // Select test type (auto/manual)
        function selectTestType(type) {
            testType = type;
            
            // Update UI
            document.querySelectorAll('.difficulty-option[data-level]').forEach(el => {
                el.classList.remove('selected');
            });
            document.querySelector(`.difficulty-option[data-level="${type}"]`).classList.add('selected');
            
            // Show/hide sections
            if (type === 'auto') {
                document.getElementById('difficultySection').classList.remove('hidden');
                document.getElementById('manualSection').classList.add('hidden');
            } else {
                document.getElementById('difficultySection').classList.add('hidden');
                document.getElementById('manualSection').classList.remove('hidden');
                updateAvailableQuestions();
            }
        }

        // Select difficulty level
        function selectDifficulty(level) {
            difficulty = level;
            
            // Update UI
            document.querySelectorAll('.difficulty-option[data-level]').forEach(el => {
                el.classList.remove('selected');
            });
            document.querySelector(`.difficulty-option[data-level="${level}"]`).classList.add('selected');
        }

        // Update available questions for manual selection
        function updateAvailableQuestions() {
            const classSelect = document.getElementById('testClass');
            const subjectSelect = document.getElementById('testSubject');
            const chapterSelect = document.getElementById('testChapter');
            
            const selectedClass = classSelect.value;
            const selectedSubject = subjectSelect.value;
            const selectedChapter = chapterSelect.value;
            
            const questionsContainer = document.getElementById('availableQuestions');
            questionsContainer.innerHTML = '';
            
            if (questionBank[mockType] && questionBank[mockType][selectedSubject] && 
                questionBank[mockType][selectedSubject][selectedClass] && 
                questionBank[mockType][selectedSubject][selectedClass][selectedChapter]) {
                
                const questions = questionBank[mockType][selectedSubject][selectedClass][selectedChapter];
                
                questions.forEach(question => {
                    const questionItem = document.createElement('div');
                    questionItem.className = 'question-item';
                    
                    const questionText = document.createElement('div');
                    questionText.className = 'question-text';
                    questionText.textContent = question.text;
                    
                    const questionDifficulty = document.createElement('div');
                    questionDifficulty.className = `question-difficulty difficulty-${question.difficulty}`;
                    questionDifficulty.textContent = question.difficulty.charAt(0).toUpperCase() + question.difficulty.slice(1);
                    
                    const questionCheckbox = document.createElement('input');
                    questionCheckbox.type = 'checkbox';
                    questionCheckbox.value = question.id;
                    
                    questionItem.appendChild(questionText);
                    questionItem.appendChild(questionDifficulty);
                    questionItem.appendChild(questionCheckbox);
                    
                    questionsContainer.appendChild(questionItem);
                });
            } else {
                questionsContainer.innerHTML = '<p>No questions available for the selected criteria.</p>';
            }
        }

        // Generate custom test
       async function generateCustomTest() {
    const classSelect = document.getElementById('testClass');
    const subjectSelect = document.getElementById('testSubject');
    const chapterSelect = document.getElementById('testChapter');
    const questionCount = parseInt(document.getElementById('questionCount').value);
    const duration = parseInt(document.getElementById('testDuration').value);
    
    const selectedClass = classSelect.value;
    const selectedSubject = subjectSelect.value;
    const selectedChapter = chapterSelect.value;
    
    let questions = [];
    
    if (testType === 'auto') {
        // Auto-generate based on difficulty
        if (questionBank[mockType] && questionBank[mockType][selectedSubject] && 
            questionBank[mockType][selectedSubject][selectedClass] && 
            questionBank[mockType][selectedSubject][selectedClass][selectedChapter]) {
            
            let availableQuestions = questionBank[mockType][selectedSubject][selectedClass][selectedChapter];
            
            // Filter by difficulty if not mixed
            if (difficulty !== 'mixed') {
                availableQuestions = availableQuestions.filter(q => q.difficulty === difficulty);
            }
            
            // Shuffle and select required number of questions
            availableQuestions = shuffleArray(availableQuestions);
            questions = availableQuestions.slice(0, Math.min(questionCount, availableQuestions.length));
        }
    } else {
        // Manual selection
        const selectedQuestions = Array.from(document.querySelectorAll('#availableQuestions input:checked'))
            .map(cb => parseInt(cb.value));
        
        if (questionBank[mockType] && questionBank[mockType][selectedSubject] && 
            questionBank[mockType][selectedSubject][selectedClass] && 
            questionBank[mockType][selectedSubject][selectedClass][selectedChapter]) {
            
            const allQuestions = questionBank[mockType][selectedSubject][selectedClass][selectedChapter];
            questions = allQuestions.filter(q => selectedQuestions.includes(q.id));
        }
    }
    
    if (questions.length === 0) {
        alert('No questions available for the selected criteria. Please try different options.');
        return;
    }
    
    // Create test object with proper question structure
    const test = {
        id: Date.now(),
        title: `${mockType.toUpperCase()} ${selectedSubject.charAt(0).toUpperCase() + selectedSubject.slice(1)} Test - ${selectedChapter}`,
        type: mockType,
        subject: selectedSubject,
        chapter: selectedChapter,
        class: selectedClass,
        questions: questions.map(q => ({
            id: q.id,
            text: q.text,
            options: q.options || ['Option A', 'Option B', 'Option C', 'Option D'],
            answer: q.answer || 'A',
            difficulty: q.difficulty || 'medium',
            solution: q.solution || 'Solution not available'
        })),
        duration: duration,
        createdAt: new Date().toISOString()
    };
    
    // Start the test
    startTest(test);
}

        // Shuffle array (Fisher-Yates algorithm)
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        // Load available tests
       // Load available tests
async function loadAvailableTests() {
    try {
        const response = await fetch('/api/tests', {
            headers: {
                'Authorization': `Bearer ${currentRole}-token`
            }
        });
        
        if (response.status === 401) {
            console.log('Authentication required');
            // Fallback to sample tests
            loadSampleTests();
            return;
        }
        
        const data = await response.json();
        
        if (data.success) {
            displayTests(data.tests);
        } else {
            // Fallback to sample tests
            loadSampleTests();
        }
    } catch (error) {
        console.error('Error loading tests:', error);
        // Fallback to sample tests
        loadSampleTests();
    }
}

        // Display tests
        function displayTests(tests) {
    const testsGrid = document.getElementById('testsGrid');
    testsGrid.innerHTML = '';
    
    if (!tests || !Array.isArray(tests)) {
        testsGrid.innerHTML = '<p>No tests available at the moment.</p>';
        return;
    }
    
    tests.forEach(test => {
        const testCard = document.createElement('div');
        testCard.className = 'test-card';
        testCard.onclick = () => startTest(test);
        
        // Safe property access with fallbacks
        const testType = test.type || 'jee';
        const testTitle = test.title || 'Mock Test';
        const testClass = test.class || '11';
        const questionCount = test.questions ? test.questions.length : (test.questionCount || 10);
        const duration = test.duration || 30;
        const difficulty = test.difficulty || 'mixed';
        
        testCard.innerHTML = `
            <div class="test-badge">${String(testType).toUpperCase()}</div>
            <h3>${testTitle}</h3>
            <p><strong>Class:</strong> ${testClass}</p>
            <p><strong>Questions:</strong> ${questionCount}</p>
            <p><strong>Duration:</strong> ${duration} min</p>
            <p><strong>Difficulty:</strong> ${String(difficulty).charAt(0).toUpperCase() + String(difficulty).slice(1)}</p>
            <div style="margin-top: 1rem;">
                <button class="btn btn-primary" style="width: 100%;">Start Test</button>
            </div>
        `;
        
        testsGrid.appendChild(testCard);
    });
}



        // Load sample tests (fallback)
        function loadSampleTests() {
    const sampleTests = [
        {
            id: 1,
            title: 'JEE Mathematics - Integration',
            subject: 'mathematics',
            type: 'jee',
            class: '12',
            chapter: 'Integrals',
            questions: [
                {
                    id: 1,
                    text: 'What is ∫(3x² + 2x + 1) dx?',
                    options: ['x³ + x² + x + C', 'x³ + 2x² + x + C', '3x³ + x² + x + C', 'x³ + x² + 2x + C'],
                    answer: 'A',
                    difficulty: 'easy',
                    solution: 'Apply power rule: ∫3x² dx = x³, ∫2x dx = x², ∫1 dx = x'
                },
                {
                    id: 2,
                    text: 'Evaluate ∫sin(x)cos(x) dx',
                    options: ['(1/2)sin²(x) + C', '(1/2)cos²(x) + C', '-(1/2)cos(2x) + C', '(1/4)sin(2x) + C'],
                    answer: 'D',
                    difficulty: 'medium',
                    solution: 'Use identity: sin(x)cos(x) = (1/2)sin(2x), then integrate'
                }
            ],
            duration: 30,
            difficulty: 'mixed'
        },
        {
            id: 2,
            title: 'NEET Biology - Human Physiology',
            subject: 'biology',
            type: 'neet',
            class: '11',
            chapter: 'Human Physiology',
            questions: [
                {
                    id: 3,
                    text: 'Which organ produces insulin?',
                    options: ['Liver', 'Pancreas', 'Kidney', 'Stomach'],
                    answer: 'B',
                    difficulty: 'easy',
                    solution: 'The pancreas produces insulin in the islets of Langerhans'
                },
                {
                    id: 4,
                    text: 'What is the normal blood pressure range in humans?',
                    options: ['120/80 mmHg', '140/90 mmHg', '100/60 mmHg', '130/85 mmHg'],
                    answer: 'A',
                    difficulty: 'easy',
                    solution: 'Normal blood pressure is typically around 120/80 mmHg'
                }
            ],
            duration: 45,
            difficulty: 'mixed'
        }
    ];
    
    displayTests(sampleTests);
}

        // Start test
      function startTest(test) {
    currentTest = test;
    currentQuestionIndex = 0;
    userAnswers = {};
    timeRemaining = test.duration * 60;
    
    // Ensure questions are properly loaded
    if (!test.questions || test.questions.length === 0) {
        alert('No questions available for this test. Please try another test.');
        return;
    }
    
    // Show test interface
    document.getElementById('testInterface').classList.remove('hidden');
    document.getElementById('dashboard').style.display = 'none';
    
    // Initialize test
    document.getElementById('testTitle').textContent = test.title;
    updateTimerDisplay();
    showQuestion(currentQuestionIndex);
    updateQuestionPalette();
    
    // Start timer
    testTimer = setInterval(updateTimer, 1000);
}
        // Update timer
        function updateTimer() {
            timeRemaining--;
            updateTimerDisplay();
            
            if (timeRemaining <= 0) {
                submitTest();
            }
        }

        // Update timer display
        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('testTimer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Show question
       function showQuestion(index) {
    if (!currentTest || !currentTest.questions || !currentTest.questions[index]) {
        console.error('Question not found:', index);
        return;
    }
    
    const question = currentTest.questions[index];
    document.getElementById('currentQuestionText').textContent = `${index + 1}. ${question.text}`;
    
    const optionsContainer = document.getElementById('optionsContainer');
    optionsContainer.innerHTML = '';
    
    if (!question.options || question.options.length === 0) {
        optionsContainer.innerHTML = '<div class="option">No options available</div>';
        return;
    }
    
    question.options.forEach((option, i) => {
        const optionElement = document.createElement('div');
        optionElement.className = 'option';
        if (userAnswers[question.id] === String.fromCharCode(65 + i)) {
            optionElement.classList.add('selected');
        }
        optionElement.textContent = `${String.fromCharCode(65 + i)}. ${option}`;
        optionElement.onclick = () => selectOption(String.fromCharCode(65 + i));
        optionsContainer.appendChild(optionElement);
    });
    
    // Update navigation buttons
    document.getElementById('prevBtn').disabled = index === 0;
    document.getElementById('nextBtn').disabled = index === currentTest.questions.length - 1;
    
    // Update palette
    updateQuestionPalette();
}

        // Select option
        function selectOption(option) {
            const question = currentTest.questions[currentQuestionIndex];
            userAnswers[question.id] = option;
            
            // Update UI
            document.querySelectorAll('.option').forEach(el => {
                el.classList.remove('selected');
            });
            event.target.classList.add('selected');
            
            // Update palette
            updateQuestionPalette();
        }

        // Next question
        function nextQuestion() {
            if (currentQuestionIndex < currentTest.questions.length - 1) {
                currentQuestionIndex++;
                showQuestion(currentQuestionIndex);
            }
        }

        // Previous question
        function prevQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                showQuestion(currentQuestionIndex);
            }
        }

        // Update question palette
        function updateQuestionPalette() {
            const palette = document.getElementById('questionPalette');
            palette.innerHTML = '';
            
            currentTest.questions.forEach((question, index) => {
                const item = document.createElement('div');
                item.className = 'palette-item';
                if (index === currentQuestionIndex) {
                    item.classList.add('current');
                }
                if (userAnswers[question.id]) {
                    item.classList.add('answered');
                }
                item.textContent = index + 1;
                item.onclick = () => {
                    currentQuestionIndex = index;
                    showQuestion(index);
                };
                palette.appendChild(item);
            });
        }

        // Submit test
        async function submitTest() {
            clearInterval(testTimer);
            
            // Calculate score
            let correct = 0;
            currentTest.questions.forEach(question => {
                if (userAnswers[question.id] === question.answer) {
                    correct++;
                }
            });
            
            const score = (correct / currentTest.questions.length) * 100;
            
            // Save test result
            try {
                const response = await fetch('/api/test-results', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentRole}-token`
                    
                    },
                    body: JSON.stringify({
                        testId: currentTest.id,
                        testTitle: currentTest.title,
                        answers: userAnswers,
                        score: score,
                        totalQuestions: currentTest.questions.length,
                        timeSpent: currentTest.duration * 60 - timeRemaining
                    })
                });
                
                const data = await response.json();
                if (!data.success) {
                    console.error('Failed to save test result');
                }
            } catch (error) {
                console.error('Error saving test result:', error);
            }
            
            // Show results
            alert(`Test submitted!\nYour score: ${correct}/${currentTest.questions.length} (${score.toFixed(1)}%)`);
            
            // Hide test interface and show dashboard
            document.getElementById('testInterface').classList.add('hidden');
            document.getElementById('dashboard').style.display = 'block';
            
            // Update performance metrics
            updatePerformanceMetrics();
        }

        // Update performance metrics
        // Fix performance metrics loading
async function updatePerformanceMetrics() {
    try {
        // For demo purposes, set some default values
        document.getElementById('totalTests').textContent = '3';
        document.getElementById('avgScore').textContent = '72.5%';
        document.getElementById('bestScore').textContent = '85%';
        document.getElementById('totalTime').textContent = '4.2h';
        
        // Create sample performance data for chart
        const sampleResults = [
            { score: 70, testTitle: 'Test 1' },
            { score: 75, testTitle: 'Test 2' },
            { score: 85, testTitle: 'Test 3' },
            { score: 65, testTitle: 'Test 4' },
            { score: 80, testTitle: 'Test 5' }
        ];
        
        updatePerformanceChart(sampleResults);
        
        /* Comment out API call until authentication is fixed
        const response = await fetch('/api/test-results', {
            headers: {
                'Authorization': `Bearer ${currentRole}-token`
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                // ... existing code ...
            }
        }
        */
    } catch (error) {
        console.error('Error loading performance metrics:', error);
        // Default values already set above
    }
}

// Update loadSampleTests function
function loadSampleTests() {
    const sampleTests = [
        {
            id: 1,
            title: 'JEE Mathematics - Integration',
            subject: 'mathematics',
            type: 'jee',
            class: '12',
            chapter: 'Integrals',
            questions: [
                {
                    id: 1,
                    text: 'What is ∫(3x² + 2x + 1) dx?',
                    options: ['x³ + x² + x + C', 'x³ + 2x² + x + C', '3x³ + x² + x + C', 'x³ + x² + 2x + C'],
                    answer: 'A',
                    difficulty: 'easy',
                    solution: 'Apply power rule: ∫3x² dx = x³, ∫2x dx = x², ∫1 dx = x'
                }
            ],
            questionCount: 5,
            duration: 30,
            difficulty: 'mixed'
        },
        {
            id: 2,
            title: 'NEET Biology - Human Physiology',
            subject: 'biology',
            type: 'neet',
            class: '11',
            chapter: 'Human Physiology',
            questions: [
                {
                    id: 2,
                    text: 'Which organ produces insulin?',
                    options: ['Liver', 'Pancreas', 'Kidney', 'Stomach'],
                    answer: 'B',
                    difficulty: 'easy',
                    solution: 'The pancreas produces insulin in the islets of Langerhans'
                }
            ],
            questionCount: 10,
            duration: 45,
            difficulty: 'mixed'
        }
    ];
    
    displayTests(sampleTests);
}

        // Update performance chart
        // Update performance chart
function updatePerformanceChart(results) {
    const chart = document.getElementById('performanceChart');
    chart.innerHTML = '';
    
    if (!results || results.length === 0) {
        chart.innerHTML = '<p style="text-align: center; padding: 2rem;">No test results available yet.</p>';
        return;
    }
    
    // Use last 5 results or all if less than 5
    const recentResults = results.slice(-5);
    const maxScore = Math.max(...recentResults.map(result => result.score), 100); // Ensure we have a max value
    
    recentResults.forEach((result, index) => {
        const bar = document.createElement('div');
        bar.className = 'chart-bar';
        bar.style.height = `${(result.score / maxScore) * 100}%`;
        
        const label = document.createElement('div');
        label.className = 'chart-label';
        label.textContent = `Test ${index + 1}`;
        
        // Add tooltip with score
        bar.title = `Score: ${result.score.toFixed(1)}%`;
        
        bar.appendChild(label);
        chart.appendChild(bar);
    });
}

        // Get AI guidance
// Get AI guidance
// Add this to your frontend JavaScript
// Fix the AI guidance function
async function getAIGuidance() {
    const query = document.getElementById('aiQuery').value.trim();
    if (!query) {
        alert('Please enter a question or topic for AI guidance.');
        return;
    }
    
    const resultDiv = document.getElementById('guidanceResult');
    resultDiv.innerHTML = '<div class="loading" style="text-align: center; padding: 2rem;">Generating personalized guidance...</div>';
    
    try {
        const token = localStorage.getItem('authToken') || `${currentRole}-token`;
        
        const response = await fetch('/api/ai-guidance', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ query })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            resultDiv.innerHTML = data.guidance;
        } else {
            resultDiv.innerHTML = `
                <div class="guidance-result">
                    <div class="guidance-header">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Error</h3>
                    </div>
                    <div class="guidance-content">
                        <p>${data.error || 'Unable to generate guidance at the moment.'}</p>
                    </div>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error getting AI guidance:', error);
        resultDiv.innerHTML = `
            <div class="guidance-result">
                <div class="guidance-header">
                    <i class="fas fa-wifi"></i>
                    <h3>Connection Issue</h3>
                </div>
                <div class="guidance-content">
                    <p>Unable to connect to AI service. Here's some general guidance:</p>
                    <div class="quick-tips">
                        <h4>General Study Tips</h4>
                        <ul>
                            <li>Focus on NCERT textbooks for fundamental concepts</li>
                            <li>Practice previous years' question papers</li>
                            <li>Take regular mock tests to identify weak areas</li>
                            <li>Maintain a consistent study schedule</li>
                            <li>Revise regularly and make concise notes</li>
                        </ul>
                    </div>
                </div>
            </div>
        `;
    }
}

// Add this simple offline guidance function
function generateOfflineGuidance(query) {
    return `
        <h4>General Study Strategy:</h4>
        <ol>
            <li><strong>Focus on NCERT:</strong> Master all concepts from NCERT textbooks</li>
            <li><strong>Practice Daily:</strong> Solve at least 50 problems daily</li>
            <li><strong>Mock Tests:</strong> Take regular timed practice tests</li>
            <li><strong>Revision:</strong> Revise formulas and concepts weekly</li>
        </ol>
        <p><strong>Your Query:</strong> "${query}" - Please try rephrasing or ask about specific topics like Integration, Organic Chemistry, Mechanics, etc.</p>
    `;
}
        // Refresh tests
        function refreshTests() {
            loadAvailableTests();
        }

        // Admin functions
        function updateSubjectsForAdmin() {
            const examType = document.getElementById('examType').value;
            const subjectSelect = document.getElementById('questionSubject');
            subjectSelect.innerHTML = '';
            
            let subjects = [];
            if (examType === 'jee') {
                subjects = ['physics', 'chemistry', 'mathematics'];
            } else if (examType === 'neet') {
                subjects = ['physics', 'chemistry', 'biology'];
            }
            
            subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject;
                option.textContent = subject.charAt(0).toUpperCase() + subject.slice(1);
                subjectSelect.appendChild(option);
            });
            
            updateChaptersForAdmin();
        }

        function updateChaptersForAdmin() {
            const examType = document.getElementById('examType').value;
            const classSelect = document.getElementById('questionClass');
            const subjectSelect = document.getElementById('questionSubject');
            const chapterSelect = document.getElementById('questionChapter');
            
            const selectedClass = classSelect.value;
            const selectedSubject = subjectSelect.value;
            
            chapterSelect.innerHTML = '';
            
            if (questionBank[examType] && questionBank[examType][selectedSubject] && questionBank[examType][selectedSubject][selectedClass]) {
                const chapters = Object.keys(questionBank[examType][selectedSubject][selectedClass]);
                
                chapters.forEach(chapter => {
                    const option = document.createElement('option');
                    option.value = chapter;
                    option.textContent = chapter;
                    chapterSelect.appendChild(option);
                });
            }
            
            loadQuestionsForAdmin();
        }

        function showQuestionManagement() {
            document.getElementById('questionManagement').classList.remove('hidden');
            document.getElementById('testManagement').classList.add('hidden');
            loadQuestionsForAdmin();
        }

        function showTestManagement() {
            document.getElementById('questionManagement').classList.add('hidden');
            document.getElementById('testManagement').classList.remove('hidden');
            loadTestsForAdmin();
        }

        function loadQuestionsForAdmin() {
            const examType = document.getElementById('examType').value;
            const classSelect = document.getElementById('questionClass');
            const subjectSelect = document.getElementById('questionSubject');
            const chapterSelect = document.getElementById('questionChapter');
            
            const selectedClass = classSelect.value;
            const selectedSubject = subjectSelect.value;
            const selectedChapter = chapterSelect.value;
            
            const questionList = document.getElementById('questionList');
            questionList.innerHTML = '';
            
            if (questionBank[examType] && questionBank[examType][selectedSubject] && 
                questionBank[examType][selectedSubject][selectedClass] && 
                questionBank[examType][selectedSubject][selectedClass][selectedChapter]) {
                
                const questions = questionBank[examType][selectedSubject][selectedClass][selectedChapter];
                
                questions.forEach(question => {
                    const questionItem = document.createElement('div');
                    questionItem.className = 'question-item';
                    
                    const questionText = document.createElement('div');
                    questionText.className = 'question-text';
                    questionText.textContent = question.text;
                    
                    const questionDetails = document.createElement('div');
                    questionDetails.innerHTML = `
                        <div class="question-difficulty difficulty-${question.difficulty}">${question.difficulty.charAt(0).toUpperCase() + question.difficulty.slice(1)}</div>
                        <div>Correct: ${question.answer}</div>
                    `;
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn btn-secondary';
                    deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                    deleteBtn.onclick = () => deleteQuestion(question.id);
                    
                    questionItem.appendChild(questionText);
                    questionItem.appendChild(questionDetails);
                    questionItem.appendChild(deleteBtn);
                    
                    questionList.appendChild(questionItem);
                });
            } else {
                questionList.innerHTML = '<p>No questions available for the selected criteria.</p>';
            }
        }

        function loadTestsForAdmin() {
            const testsList = document.getElementById('adminTestsList');
            testsList.innerHTML = '<p>Test management functionality would be implemented here.</p>';
        }

        async function addQuestion() {
            const examType = document.getElementById('examType').value;
            const classVal = document.getElementById('questionClass').value;
            const subject = document.getElementById('questionSubject').value;
            const chapter = document.getElementById('questionChapter').value;
            const difficulty = document.getElementById('questionDifficulty').value;
            const text = document.getElementById('questionText').value;
            const optionA = document.getElementById('optionA').value;
            const optionB = document.getElementById('optionB').value;
            const optionC = document.getElementById('optionC').value;
            const optionD = document.getElementById('optionD').value;
            const correctAnswer = document.getElementById('correctAnswer').value;
            const solution = document.getElementById('questionSolution').value;
            
            // Validate inputs
            if (!text || !optionA || !optionB || !optionC || !optionD || !solution) {
                alert('Please fill in all fields.');
                return;
            }
            
            // Create question object
            const newQuestion = {
                text: text,
                options: [optionA, optionB, optionC, optionD],
                answer: correctAnswer,
                difficulty: difficulty,
                solution: solution
            };
            
            try {
                const response = await fetch('/api/questions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
'Authorization': `Bearer ${currentRole}-token`                    },
                    body: JSON.stringify({
                        examType,
                        class: classVal,
                        subject,
                        chapter,
                        difficulty,
                        question: newQuestion
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Clear form
                    document.getElementById('questionText').value = '';
                    document.getElementById('optionA').value = '';
                    document.getElementById('optionB').value = '';
                    document.getElementById('optionC').value = '';
                    document.getElementById('optionD').value = '';
                    document.getElementById('questionSolution').value = '';
                    
                    // Reload questions
                    loadQuestionsForAdmin();
                    
                    alert('Question added successfully!');
                } else {
                    alert('Failed to add question: ' + data.error);
                }
            } catch (error) {
                console.error('Error adding question:', error);
                alert('Error adding question. Please try again.');
            }
        }

        async function deleteQuestion(questionId) {
            if (confirm('Are you sure you want to delete this question?')) {
                try {
                    const response = await fetch(`/api/questions/${questionId}`, {
                        method: 'DELETE',
                        headers: {
'Authorization': `Bearer ${currentRole}-token`                        }
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        loadQuestionsForAdmin();
                    } else {
                        alert('Failed to delete question: ' + data.error);
                    }
                } catch (error) {
                    console.error('Error deleting question:', error);
                    alert('Error deleting question. Please try again.');
                }
            }
        }

        // Initialize the app when the page loads
        window.onload = init;
    </script>
</body>
</html>